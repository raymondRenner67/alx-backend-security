# Deployment Guide - ALX Backend Security

Complete guide for deploying the Django application with Celery, RabbitMQ, and public Swagger documentation.

## üöÄ Deployment Options

### Option 1: Render.com (Recommended)
‚úÖ Full support for Celery and RabbitMQ  
‚úÖ Free tier available  
‚úÖ Easy configuration  
‚úÖ Automatic deployments from GitHub  

### Option 2: PythonAnywhere
‚ö†Ô∏è Limited free tier (no Celery support)  
‚úÖ Good for simple deployments  
‚úÖ Easy to use  

---

## üìã Prerequisites

1. GitHub account with your code repository
2. Account on Render.com or PythonAnywhere
3. RabbitMQ instance (Render provides this)
4. Redis instance (Render provides this)

---

## üéØ Deployment on Render.com (Recommended)

### Step 1: Prepare Your Repository

1. Push your code to GitHub:
```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/your-username/alx-backend-security.git
git push -u origin main
```

2. Ensure these files are in your repository:
   - `requirements.txt`
   - `render.yaml`
   - `render_build.sh`
   - `Procfile`
   - `runtime.txt`
   - `settings_prod.py`
   - `wsgi.py`

### Step 2: Create Render Account

1. Go to https://render.com
2. Sign up with your GitHub account
3. Authorize Render to access your repository

### Step 3: Deploy Using Blueprint

1. Click "New" ‚Üí "Blueprint"
2. Connect your GitHub repository
3. Render will detect `render.yaml` automatically
4. Review the services:
   - **Web Service**: Django application
   - **Worker Service**: Celery worker
   - **Beat Service**: Celery beat scheduler
   - **PostgreSQL Database**
   - **Redis Instance**

5. Click "Apply"

### Step 4: Configure Environment Variables

Render will auto-generate most variables, but you should set:

```bash
# Required
SECRET_KEY=<auto-generated-or-custom>
DEBUG=False
ALLOWED_HOSTS=your-app.onrender.com

# Email (Optional)
EMAIL_HOST=smtp.gmail.com
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=noreply@yourdomain.com
```

### Step 5: Manual Setup (Alternative to Blueprint)

If not using `render.yaml`, create services manually:

#### 5a. Create PostgreSQL Database
1. New ‚Üí PostgreSQL
2. Name: `alx-backend-security-db`
3. Free tier
4. Copy the Internal Database URL

#### 5b. Create Redis Instance
1. New ‚Üí Redis
2. Name: `alx-backend-security-redis`
3. Free tier
4. Copy the Internal Redis URL

#### 5c. Create Web Service
1. New ‚Üí Web Service
2. Connect GitHub repository
3. Settings:
   - **Name**: `alx-backend-security`
   - **Environment**: `Python 3`
   - **Build Command**: `./render_build.sh`
   - **Start Command**: `gunicorn wsgi:application --bind 0.0.0.0:$PORT`
   - **Environment Variables**:
     ```
     DJANGO_SETTINGS_MODULE=settings_prod
     DATABASE_URL=<from PostgreSQL>
     REDIS_URL=<from Redis>
     CELERY_BROKER_URL=amqp://guest:guest@localhost:5672//
     SECRET_KEY=<generate strong key>
     DEBUG=False
     ```

#### 5d. Create Celery Worker
1. New ‚Üí Background Worker
2. Connect same repository
3. Settings:
   - **Name**: `alx-backend-security-worker`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `celery -A celery worker --loglevel=info`
   - **Environment Variables**: Same as web service

#### 5e. Create Celery Beat
1. New ‚Üí Background Worker
2. Connect same repository
3. Settings:
   - **Name**: `alx-backend-security-beat`
   - **Start Command**: `celery -A celery beat --loglevel=info`
   - **Environment Variables**: Same as web service

### Step 6: Setup RabbitMQ

**Option A: Use CloudAMQP (Recommended for Render)**

1. Go to https://www.cloudamqp.com
2. Sign up for free tier
3. Create a new instance
4. Copy the AMQP URL
5. Add to Render environment variables:
   ```
   CELERY_BROKER_URL=<CloudAMQP URL>
   ```

**Option B: Use Redis as Broker (Simpler)**

Update environment variable:
```
CELERY_BROKER_URL=<same as REDIS_URL>
```

### Step 7: Run Migrations

Once deployed, access the shell:
```bash
# From Render dashboard ‚Üí Web Service ‚Üí Shell
python manage.py migrate
python manage.py createsuperuser
```

### Step 8: Access Your Application

Your app will be available at:
- **Main Site**: `https://your-app.onrender.com`
- **Swagger API Docs**: `https://your-app.onrender.com/swagger/`
- **ReDoc**: `https://your-app.onrender.com/redoc/`
- **Admin Panel**: `https://your-app.onrender.com/admin/`

---

## üß™ Testing the Deployment

### 1. Test Swagger Documentation

Visit `https://your-app.onrender.com/swagger/`

You should see:
- ‚úÖ Interactive API documentation
- ‚úÖ All endpoints listed
- ‚úÖ Try out functionality working

### 2. Test API Endpoints

```bash
# Get statistics
curl https://your-app.onrender.com/api/stats/

# List request logs
curl https://your-app.onrender.com/api/request-logs/

# Check if IP is blocked
curl https://your-app.onrender.com/api/blocked-ips/check/192.168.1.1/
```

### 3. Test IP Tracking

```bash
# Make a request (will be logged)
curl https://your-app.onrender.com/

# Check admin to see the logged request
```

### 4. Test Rate Limiting

```bash
# Test login endpoint (should be rate limited after 5 requests)
for i in {1..10}; do 
  curl -X POST https://your-app.onrender.com/ip_tracking/login/ \
    -d "username=test&password=test"
  echo "\nRequest $i"
done
```

### 5. Test Celery Worker

```bash
# From Render shell
python manage.py shell

>>> from celery import current_app
>>> from ip_tracking.tasks import detect_anomalies
>>> result = detect_anomalies.delay()
>>> result.get(timeout=10)
```

### 6. Test Anomaly Detection

The Celery beat scheduler will run `detect_anomalies` every hour.

Check logs in Render dashboard:
- Go to Celery Beat service
- View logs
- Should see hourly task execution

### 7. Test Email Notifications (if configured)

```bash
python manage.py shell

>>> from django.core.mail import send_mail
>>> send_mail(
...     'Test Email',
...     'This is a test from your deployed app.',
...     'noreply@yourdomain.com',
...     ['your-email@example.com'],
... )
```

---

## üìä Monitoring

### Render Dashboard

Monitor your services:
1. **Web Service**: Check response times and errors
2. **Worker Service**: Monitor Celery task execution
3. **Database**: Check connection and usage
4. **Redis**: Monitor cache hit rates

### Application Logs

View logs for each service:
```bash
# From Render dashboard
Web Service ‚Üí Logs
Worker Service ‚Üí Logs
Beat Service ‚Üí Logs
```

### Django Admin

Access admin panel to:
- View request logs with geolocation
- Manage blocked IPs
- Review suspicious IPs flagged by anomaly detection

---

## üîí Security Checklist

- [x] `DEBUG = False` in production
- [x] Strong `SECRET_KEY` generated
- [x] `ALLOWED_HOSTS` configured correctly
- [x] SSL/HTTPS enabled (automatic on Render)
- [x] Database credentials secured
- [x] Email credentials secured
- [x] CORS properly configured
- [x] Security headers enabled

---

## üêõ Troubleshooting

### Swagger Not Accessible

**Problem**: 404 error on `/swagger/`

**Solution**:
1. Check `urls.py` includes Swagger routes
2. Verify `drf-spectacular` is in `INSTALLED_APPS`
3. Check logs for errors
4. Run: `python manage.py spectacular --file schema.yml`

### Celery Not Processing Tasks

**Problem**: Tasks not executing

**Solutions**:
1. Check worker service is running in Render dashboard
2. Verify `CELERY_BROKER_URL` is correct
3. Check worker logs for errors
4. Test broker connection:
   ```python
   from celery import current_app
   current_app.connection().ensure_connection(max_retries=3)
   ```

### Database Connection Errors

**Problem**: Can't connect to database

**Solutions**:
1. Verify `DATABASE_URL` is set correctly
2. Check PostgreSQL service is running
3. Ensure migrations have been run
4. Check database logs in Render

### Geolocation Not Working

**Problem**: Country/City fields are empty

**Solutions**:
1. Check outbound connections are allowed (they are on Render)
2. Verify internet connectivity to ip-api.com
3. Check logs for geolocation errors
4. Test manually:
   ```python
   import requests
   response = requests.get('http://ip-api.com/json/8.8.8.8')
   print(response.json())
   ```

### Rate Limiting Not Working

**Problem**: Rate limits not being enforced

**Solutions**:
1. Verify Redis is connected
2. Check `RATELIMIT_ENABLE = True` in settings
3. Ensure middleware order is correct
4. Test cache connection:
   ```python
   from django.core.cache import cache
   cache.set('test', 'value')
   print(cache.get('test'))
   ```

---

## üìù Maintenance

### Update Deployment

```bash
# Make changes locally
git add .
git commit -m "Update features"
git push origin main

# Render will automatically redeploy
```

### Manual Redeploy

From Render dashboard:
1. Go to your service
2. Click "Manual Deploy"
3. Select "Clear build cache & deploy"

### Run Management Commands

```bash
# From Render shell
python manage.py migrate
python manage.py createsuperuser
python manage.py block_ip 192.168.1.100
```

### Database Backup

Render PostgreSQL automatic backups:
- Free tier: No backups
- Paid tier: Automated daily backups

Manual backup:
```bash
# From Render dashboard ‚Üí Database ‚Üí Connection
pg_dump <DATABASE_URL> > backup.sql
```

---

## üí° Best Practices

1. **Use Environment Variables**: Never commit secrets
2. **Monitor Logs**: Check regularly for errors
3. **Set Up Alerts**: Configure Render alerts for downtime
4. **Use HTTPS**: Always (automatic on Render)
5. **Regular Backups**: Schedule database backups
6. **Update Dependencies**: Keep packages up to date
7. **Security Headers**: Already configured in settings
8. **Rate Limiting**: Protect your endpoints
9. **Documentation**: Keep Swagger docs updated
10. **Testing**: Test before deploying to production

---

## üìö Additional Resources

- [Render Documentation](https://render.com/docs)
- [Celery Documentation](https://docs.celeryproject.org/)
- [Django Deployment Checklist](https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/)
- [DRF Spectacular Docs](https://drf-spectacular.readthedocs.io/)
- [CloudAMQP RabbitMQ](https://www.cloudamqp.com/)

---

## üéâ Success!

Your application is now deployed with:
- ‚úÖ Django application running on Gunicorn
- ‚úÖ PostgreSQL database
- ‚úÖ Redis for caching
- ‚úÖ RabbitMQ for Celery broker
- ‚úÖ Celery worker processing background tasks
- ‚úÖ Celery beat running scheduled tasks
- ‚úÖ Swagger documentation publicly accessible at `/swagger/`
- ‚úÖ IP tracking with geolocation
- ‚úÖ Rate limiting active
- ‚úÖ Anomaly detection running hourly

**Public Swagger Documentation**: `https://your-app.onrender.com/swagger/`
